import React, { useState, useEffect, useRef } from 'react';
import { 
  TrendingUp, TrendingDown, Search, Newspaper, 
  BarChart3, Loader2, Activity, History, Settings2,
  Zap, ArrowUpRight, ArrowDownRight
} from 'lucide-react';

/**
 * QUANTA PRO - Trading Simulator Edition
 * גרסה הכוללת שליטה ידנית במחיר וגרף אינטראקטיבי
 */

const GEMINI_API_KEY = ""; // המפתח מוזרק אוטומטית

const App = () => {
  const [ticker, setTicker] = useState('NVDA');
  const [priceInput, setPriceInput] = useState('132.45');
  const [stockData, setStockData] = useState({ 
    symbol: 'NVDA', 
    price: 132.45, 
    change: 2.41, 
    changePercent: 1.85 
  });
  const [analysis, setAnalysis] = useState(null);
  const [loading, setLoading] = useState(false);
  const [portfolio, setPortfolio] = useState({ balance: 25000, shares: 0 });
  const chartContainerRef = useRef(null);
  const chartRef = useRef(null);
  const seriesRef = useRef(null);

  // פונקציה לניתוח AI על בסיס המחיר שהוזן
  const performAIAnalysis = async (symbol, currentPrice) => {
    const prompt = `נתח את המניה ${symbol} במחיר ${currentPrice}$. האם זה מחיר טוב לקנייה? ענה בעברית קצרה ומקצועית. החזר JSON: {"sentiment": "positive/negative", "summary": "...", "recommendation": "BUY/SELL/HOLD"}`;
    
    try {
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { responseMimeType: "application/json" }
          })
        }
      );
      const result = await response.json();
      return JSON.parse(result.candidates[0].content.parts[0].text);
    } catch (err) {
      return { sentiment: 'neutral', summary: "לא ניתן להתחבר ל-AI כרגע.", recommendation: "HOLD" };
    }
  };

  // אתחול הגרף
  useEffect(() => {
    if (!chartContainerRef.current) return;

    // טעינת הספרייה באופן דינמי אם היא לא קיימת
    const script = document.createElement('script');
    script.src = "https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js";
    script.onload = () => {
      const chart = window.LightweightCharts.createChart(chartContainerRef.current, {
        width: chartContainerRef.current.clientWidth,
        height: 300,
        layout: { backgroundColor: 'transparent', textColor: '#94a3b8' },
        grid: { vertLines: { color: '#1e293b' }, horzLines: { color: '#1e293b' } },
        timeScale: { borderColor: '#1e293b' },
      });

      const series = chart.addCandlestickSeries({
        upColor: '#10b981', downColor: '#ef4444',
        wickUpColor: '#10b981', wickDownColor: '#ef4444',
      });

      // נתונים התחלתיים
      const data = [];
      let p = 130;
      let t = Math.floor(Date.now() / 1000) - 100 * 60;
      for(let i=0; i<100; i++) {
        const o = p + (Math.random()-0.5)*2;
        const c = o + (Math.random()-0.5)*2;
        data.push({ time: t + i*60, open: o, high: Math.max(o,c)+0.2, low: Math.min(o,c)-0.2, close: c });
        p = c;
      }
      series.setData(data);
      
      chartRef.current = chart;
      seriesRef.current = series;
    };
    document.head.appendChild(script);

    return () => { if (chartRef.current) chartRef.current.remove(); };
  }, []);

  const handleUpdate = async () => {
    setLoading(true);
    const newPrice = parseFloat(priceInput);
    const diff = newPrice - stockData.price;
    
    setStockData(prev => ({
      ...prev,
      price: newPrice,
      change: diff.toFixed(2),
      changePercent: ((diff / prev.price) * 100).toFixed(2)
    }));

    // עדכון הגרף בנקודה חדשה
    if (seriesRef.current) {
      const lastTime = Math.floor(Date.now() / 1000);
      seriesRef.current.update({
        time: lastTime,
        open: stockData.price,
        high: Math.max(stockData.price, newPrice) + 0.1,
        low: Math.min(stockData.price, newPrice) - 0.1,
        close: newPrice
      });
    }

    const aiRes = await performAIAnalysis(ticker, newPrice);
    setAnalysis(aiRes);
    setLoading(false);
  };

  return (
    <div className="min-h-screen bg-[#020617] text-slate-100 p-6 font-sans" dir="rtl">
      <div className="max-w-6xl mx-auto space-y-6">
        
        {/* Header Section */}
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-slate-900/50 p-6 rounded-[2rem] border border-white/5 backdrop-blur-md">
          <div className="flex items-center gap-4">
            <div className="p-3 bg-blue-600 rounded-2xl shadow-lg shadow-blue-500/20">
              <Zap size={24} className="fill-current text-white" />
            </div>
            <div>
              <h1 className="text-3xl font-black tracking-tighter italic">QUANTA<span className="text-blue-500">PRO</span></h1>
              <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Simulator & AI Terminal</p>
            </div>
          </div>
          <div className="flex gap-4 w-full md:w-auto">
            <div className="bg-black/40 px-6 py-2 rounded-2xl border border-white/5">
              <p className="text-[9px] text-slate-500 font-bold uppercase">Portfolio Balance</p>
              <p className="text-xl font-mono font-bold text-blue-400">${portfolio.balance.toLocaleString()}</p>
            </div>
            <div className="bg-black/40 px-6 py-2 rounded-2xl border border-white/5 text-left">
              <p className="text-[9px] text-slate-500 font-bold uppercase">Shares Owned</p>
              <p className="text-xl font-mono font-bold text-purple-400">{portfolio.shares}</p>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
          {/* Main Controls & Chart */}
          <div className="lg:col-span-8 space-y-6">
            <div className="bg-slate-900 border border-white/5 p-8 rounded-[2.5rem] shadow-2xl">
              <div className="flex flex-col md:flex-row gap-6 mb-8">
                <div className="flex-1">
                  <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 block mr-2">Symbol</label>
                  <input 
                    value={ticker}
                    onChange={(e) => setTicker(e.target.value.toUpperCase())}
                    className="w-full bg-black/40 border border-white/10 rounded-2xl py-3 px-6 focus:ring-1 ring-blue-500 text-lg font-bold"
                  />
                </div>
                <div className="flex-1">
                  <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 block mr-2">Set Price ($)</label>
                  <div className="flex gap-2">
                    <input 
                      type="number"
                      value={priceInput}
                      onChange={(e) => setPriceInput(e.target.value)}
                      className="flex-1 bg-black/40 border border-white/10 rounded-2xl py-3 px-6 focus:ring-1 ring-blue-500 text-lg font-mono font-bold text-emerald-400"
                    />
                    <button onClick={handleUpdate} className="bg-blue-600 hover:bg-blue-500 px-6 rounded-2xl font-bold transition-all shadow-lg shadow-blue-500/20">
                      עדכן
                    </button>
                  </div>
                </div>
              </div>

              <div className="mb-6 flex justify-between items-end">
                <div>
                  <h2 className="text-5xl font-black tracking-tighter">{ticker}</h2>
                  <div className={`flex items-center gap-1 font-bold ${Number(stockData.change) >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                    {Number(stockData.change) >= 0 ? <TrendingUp size={16} /> : <TrendingDown size={16} />}
                    {stockData.changePercent}%
                  </div>
                </div>
                <div className="text-right">
                  <p className="text-4xl font-mono font-bold">${stockData.price.toFixed(2)}</p>
                </div>
              </div>

              <div ref={chartContainerRef} className="w-full bg-black/20 rounded-2xl border border-white/5" style={{ height: '300px' }} />
            </div>
          </div>

          {/* AI Side Panel */}
          <div className="lg:col-span-4 space-y-6">
            <div className={`p-8 rounded-[2.5rem] border shadow-2xl h-full transition-all duration-700 ${
              analysis?.sentiment === 'positive' ? 'border-emerald-500/30 bg-emerald-500/5' : 
              analysis?.sentiment === 'negative' ? 'border-red-500/30 bg-red-500/5' : 'bg-slate-900 border-white/5'
            }`}>
              <div className="flex items-center gap-2 mb-6 border-b border-white/5 pb-4">
                <BarChart3 className="text-blue-500" />
                <h3 className="font-black text-xl uppercase italic tracking-tighter text-white">AI Analysis</h3>
              </div>

              {loading ? (
                <div className="py-20 flex flex-col items-center gap-4">
                  <Loader2 className="animate-spin text-blue-500" size={40} />
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Processing Market Shift...</p>
                </div>
              ) : (
                <div className="space-y-8">
                  <div className="bg-black/40 p-5 rounded-2xl border border-white/5 min-h-[120px]">
                    <p className="text-sm leading-relaxed text-slate-300 font-medium">
                      {analysis?.summary || "הזן מחיר חדש ולחץ על עדכן כדי לקבל ניתוח AI על המניה."}
                    </p>
                  </div>
                  
                  <div className="grid grid-cols-2 gap-4">
                    <div className="bg-black/20 p-4 rounded-2xl">
                      <p className="text-[9px] text-slate-500 font-black uppercase mb-1">Recommendation</p>
                      <p className={`text-2xl font-black italic ${analysis?.recommendation === 'BUY' ? 'text-emerald-400' : 'text-blue-400'}`}>
                        {analysis?.recommendation || "---"}
                      </p>
                    </div>
                    <div className="bg-black/20 p-4 rounded-2xl">
                      <p className="text-[9px] text-slate-500 font-black uppercase mb-1">Sentiment</p>
                      <p className="text-2xl font-black italic text-slate-100 uppercase">
                        {analysis?.sentiment || "---"}
                      </p>
                    </div>
                  </div>

                  <div className="flex gap-4">
                    <button className="flex-1 bg-emerald-600 hover:bg-emerald-500 py-4 rounded-2xl font-black uppercase tracking-widest text-sm transition-all shadow-lg shadow-emerald-500/20 active:scale-95">Buy</button>
                    <button className="flex-1 bg-red-600 hover:bg-red-500 py-4 rounded-2xl font-black uppercase tracking-widest text-sm transition-all shadow-lg shadow-red-500/20 active:scale-95">Sell</button>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default App;
